process {
    executor = 'slurm'

    beforeScript = """
    export PATH="/usr/bin:$PATH"
    unset XDG_RUNTIME_DIR
    export SINGULARITY_TMPDIR="\$TMPDIR"
    """

    cpus = 1
    mem = 8.GB
    time = 36.h

    withLabel: parallel {
        cpus = 4
        time = '2d'
    }

    withName: baalGetASB {
        cpus = 8
        ext.baseMemory = 32.GB
        memory = { task.ext.baseMemory * Math.pow(2, task.attempt-1) }
        // Unfortunately memory errors often manifest as a failure
        // to spawn or read from the cluster, so exit status 1 can
        // be due to a memory overrun
        errorStrategy = { task.exitStatus in [1, 137..140].flatten() ? 'retry' : 'terminate' }
    }
}

executor {
    queueSize = 50
    queue = 'standard'
}

singularity {
    runOptions = '-p'
    enabled = true
    autoMounts = true
    pullTimeout = '1h'
    envWhitelist = 'SINGULARITY_TMPDIR,TMPDIR'
}

// This file is a configuration stub, it's intended to be included by any 
// container-engine specific configuration profiles.

process {
    container = '/home/u036/u036-genomicc/shared/workspace/roskamsh/baal-nf-cache-dirs/singularity_cache/cache/oalmelid-baal-nf-env-1.3.1.img'

    withLabel: baal_chip {
        container = '/home/u036/u036-genomicc/shared/workspace/roskamsh/baal-nf-cache-dirs/singularity_cache/cache/oalmelid-baal-chip-env-1.2.1.img'
    }

    withLabel: nopeak {
        container = '/home/u036/u036-genomicc/shared/workspace/roskamsh/baal-nf-cache-dirs/singularity_cache/cache/oalmelid-nopeak-0.1.0.img'
    }

    withLabel: nopeak_utils {
        container = '/home/u036/u036-genomicc/shared/workspace/roskamsh/baal-nf-cache-dirs/singularity_cache/cache/roskamsh-nopeak-utils-latest.img'
    }
}
